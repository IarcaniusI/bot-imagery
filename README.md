# README

## /r/Pikabu

Бот, просматривающий комментарии пользователей на предмет упоминания распространённых картинок, и в случае обнаружения оставляющий комментарий с ссылкой на картинку. Искомые картинки заносятся в словарь вместе с формами упоминания и прямыми вставляемыми ссылками. В случае если кто-то случайно ответит боту, в личку автору оригинального коммента будет выслана ссылка на ответ.

По умолчанию картинки указываются в предложении в форме ```так-и-запишем.jpg```. Вместо ```так-и-запишем``` пишется название,  при этом разделителем могут выступать также символ подчёркивания или отсутствовать впринципе, однако НЕЛЬЗЯ использовать пробелы. Большие и маленькие буквы также не учитываются, поэтому комментарии "Что же, так-и-запишем.jpg", "Что же, так_и_запишем.jpg", "Что же, ТакИЗапишем.jpg" и "Что же, такизапишем.jpg" одинаково подходят.  Вместо ```jpg``` можно также использовать ```джпег```, ```джпг```, ```жпг```, ```png``` и ```пнг```.

## Эксплуатация в Linux

### Аргументы командной строки

Скриптовый файл ```bot-imagery.py``` может принимать следующие аргументы командной строки:
 - ```-h```, ```--help``` - справка с описанием аргументов;
 - ```-r```, ```--run``` ```RUNFILE``` - путь до файла с настройками выражений (по умолчанию ```./run.conf```);
 - ```-a```, ```--auth``` ```AUTHFILE``` - путь до файла с настройками подключения (по умолчанию ```./auth.conf```);
 - ```-n```, ```--no-notify``` - отключить сообщения о событиях и ответах (например, для экономии места на диске для логов);

При запуске без аргументов конфигурационные файлы должны находиться рядом с бинарным. Анализ сообщений производится только пока процесс запущен. После изменения в файлах настроек необходимо выполнить перезапуск.

### Настройка в качестве сервиса для supervisord

Предварительно должны быть установлены пакеты:
 - [python3](https://www.python.org/)
 - [supervisor](http://supervisord.org/)

Требуется установить следующие модули для ```Python 3```:
 - ```praw```
 - ```prawcore```

Выкачиваем репозиторий, после чего раскладываем файлы следующим образом:
 - ```bot-imagery.py``` в каталог ```/usr/local/bin/```
 - ```run.conf``` и ```auth.conf``` в каталог ```/usr/local/etc/bot-imagery/```
 - ```bot-imagery.conf``` в каталог ```/etc/supervisor/conf.d/```

В описанном файле ```bot-imagery.conf``` предполагается запуск сервиса от пользователя ```bot```. 
Поэтому для успешной работы необходимо сделать одно из следующих действий:
 - создать в системе пользователя с именем ```bot```;
 - изменить в файле ```bot-imagery.conf``` значение переменной ```user``` на имя существующего пользователя.

Добавляем новообразовавшийся сервис путём выполнения следующих команд:
```
supervisorctl reread
supervisorctl add bot-imagery
```

Посмотреть на статус сервисов можно командой:
```
supervisorctl status
```

Произвести запуск, остановку и перезапуск сервиса для пересчитывания конфигов можно с помошью следующих команд:
```
supervisorctl start bot-imagery
supervisorctl stop bot-imagery
supervisorctl restart bot-imagery
```

Логи будут писаться через ```rsyslog```, как правило это делается в файл ```/var/log/syslog```.

## Настройка соединения

Сперва необходимо дать Reddit сгенерировать ключ. Для этого требуется:
1. Зайти в свой аккаунт на Reddit и перейти по ссылке [www.reddit.com/prefs/apps](https://www.reddit.com/prefs/apps);
1. Нажать кнопку ```Create another app...``` (```Создать другое приложение...```);
1. В поле ```name``` (```имя```) вбить название, к примеру ```auguments-and-implants```;
1. Выбрать переключатель ```script``` (```сценарий```);
1. В поле ```redirect uri``` (```uri переадресации```) вбить ссылку для перенаправления, например [www.example.com/unused/redirect/uri](http://www.example.com/unused/redirect/uri);
1. По желанию заполнить поля ```description``` (```описание```) и ```about url``` (```о url```);
1. Нажать кнопку ```create app``` (```создать приложение```);
1. Из появившейся карточки необходимо скопировать:
    - ID, расположенный под надписью ```personal use script``` (```скрипт для личного пользования```);
    - секретный ключ, расположенный рядом с надписью ```secret``` (```секрет```).

После того как данная последовательность действий выполнена, полученными настройками можно пользоваться и для других обработчиков.

Теперь необходимо занести соответствующие настройки в ```auth.conf``` файл. Пример файла:
```
{
    "user_agent": " bot-imagery (/u/IarcaniusI)",
    "client_id": "braEnm4E3V9D01",
    "client_secret": "3F9dfp2_CspmeVd81Dkepvnwl3D",
    "username": "botusername",
    "password": "botpassword",
    "subreddit": "Pikabu"
}
```
Здесь в настройках указывается:
 - ```user_agent``` - общее имя программы и имя пользователя;
 - ```client_id``` - ID, скопированный ранне;
 - ```client_secret``` - секретный ключ, скопированный ранее;
 - ```username``` - имя пользователя;
 - ```password``` - пароль, для входа в аккаунт;
 - ```subreddit``` - название саба, к которому происходит подключение;

## Конфигурирование

### Настройки работы

Единственным конфигурационным файлом являвется файл ```run.conf```. Рассмотреть его настройку можно на следующем примере (параметр ```dict``` будет рассмотрен в следующем разделе):

```
{
    "search_name": "(\\S+\\.(jpg|джпег|джпг|жпг|png|пнг))",
    "separator": ".",
    "forward_reply": true,
    "ignore_reply": ["good\\s+bot", "bad\\s+bot"],
    "dict": [...]
}
```

Параметру ```search_name``` передаётся регулярное выражение, по которому будет производится поиск картинок.
Аргументу ```separator``` символ, выступающий в роли разделителя в картинке между самим названием и идентификатором картинки (расширением).
В случаях когда ```forward_reply``` принимает значение ```true```,  о ответах оставленных боту сообщается автору оригинального комментария(через личные сообщения), на который ответил бот; а в случае если принимает значение ```false```, то оповещений не происходит.
Список ```ignore_reply``` содержит регулярные выражения, при нахождении которых в ответах боту не происходит оповещение о оставленном сообщении ответе автору оригинального коммента.

При использовании регулярных выражений экранирование должно выполяться двойным обратным слешем ```\\```, а не одинарным.

### Составление словаря

Словарь содержит список правил, рассмотреть составление которых можно на следующем примере:

```
"dict": [
            {
                "triggers": ["так-и-запишем", "запишем", "записал"],
                "images": ["https://i.ibb.co/Y8GcJwK/image.jpg"]
            },
            {
                "triggers": ["слоупок(|-ньюус)", "slowpoke(|-news)"],
                "images": ["https://i.ibb.co/Sv01qCj/image.jpg"]
            {
                "triggers": ["охладись", "охладитель"],
                "images": ["https://i.ibb.co/p2BhNm5/1.jpg", "https://i.ibb.co/6PjsddT/2.jpg"]
            }
        ]
```

В примере присутствуют 2 правила, заключённых в фигурные скобки.
У каждого правила присутствует список ```triggers```, содержащий возможные регулярные выражения для какой-либо картинки. При поиске из названия удаляются все дефисы и символы подчёркивания, а поиск ведётся регистронезависимо. Поэтому фразы в комментариях "так-и-запишем.jpg", "так_и_запишем.jpg", "ТакИЗапишем.jpg" и "такизапишем.jpg" являются абсолютно синонимичными, и все подходят под описанное правило.

В список ```images``` передаётся список ссылок на картинки, которые должны отображаться при срабатывании указанного правила. В случае если в списке несколько ссылок, то картинка каждый раз из них выбирается случайным образом. В случае если ссылка одна, то отображается всегда она.

При использовании регулярных выражений экранирование должно выполяться двойным обратным слешем ```\\```, а не одинарным.

## Разрабочикам

### Компиляция

Для компиляции необходимо дополнительно установить модули для ```Python3```:
 - ```pyinstaller```

Для сборки выполняем команду:
```
pyinstaller ./bot-imagery.py --onefile
```

Бинарный файл будет распологаться в новосозданном каталоге ```dist```.
После сборки можно удалить как ненужные следующие объекты:
- каталог ```__pycache__```;
- каталог ```build```;
- каталог ```dist```;
- файлы с расширением ```.spec```.

Рядом с получившимся бинарным файлом необходимо рядом положить файл ```praw.ini```, поставляемый вместе с модулем ```praw```.
